<!DOCTYPE html>
<html lang="zh-CN">
    <!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
  
  <title>NSURLSession - NaCl</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
<link rel="stylesheet" href="/css/waline.css">

  
  
  
<link rel="stylesheet" href="/css/post.css">

  

  
<meta name="generator" content="Hexo 5.4.0"></head>
    <body>
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">氯化钠哦</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/projects">Projects</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/NaCl424" target="_blank">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-zhihu nav-item-icon" href="https://www.zhihu.com/hot" target="_blank">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-weibo nav-item-icon" href="https://weibo.com/" target="_blank">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        <article class="post">
    <div class="meta">
        
        <div class="date" id="date">
            
            
            
            <span>March</span>
            
            
            
            
            
            
            
            
            
            
            <span>5,</span>
            <span>2021</span>
        </div>
        

        <h2 class="title">NSURLSession</h2>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h2 id="1-URL-Session-类体系"><a href="#1-URL-Session-类体系" class="headerlink" title="1.URL Session 类体系"></a>1.URL Session 类体系</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1.NSURLSession ——会话类</span><br><span class="line">2.NSURLSessionConfiguration ——会话配置</span><br><span class="line">3.NSURLSessionTask——task抽象类</span><br><span class="line">        - NSURLSessionDataTask——普通task类</span><br><span class="line">            - NSRULSessionUploadTask——上传task类</span><br><span class="line">        - NSURLSessionDownloadTask——下载task类</span><br><span class="line">        - NSURLSessionStreamTask——流task类</span><br><span class="line"></span><br><span class="line">代理</span><br><span class="line">NSURLSessionDelegate</span><br><span class="line">NSURLSessionTaskDelegate</span><br><span class="line">NSURLSessionDataDelegate</span><br><span class="line">NSURLSessionDownloadDelegate</span><br><span class="line">NSURLSessionStreamDelegate</span><br><span class="line"></span><br><span class="line">其他</span><br><span class="line">NSURL</span><br><span class="line">NSURLRequest</span><br><span class="line">NSURLResponse</span><br><span class="line">    - NSHTTPURLResponse</span><br><span class="line">NSCachedURLResponse</span><br></pre></td></tr></table></figure>

<h2 id="2-NSURLSessionConfiguration"><a href="#2-NSURLSessionConfiguration" class="headerlink" title="2.NSURLSessionConfiguration"></a>2.NSURLSessionConfiguration</h2><p>NSURLSession可以通过sharedSession创建，也可以通过NSURLSessionConfiguration来创建。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用静态的sharedSession方法，该类使用共享的会话，该会话使用全局的Cache，Cookie和证书</span></span><br><span class="line">+ (<span class="built_in">NSURLSession</span> *)sharedSession;  </span><br><span class="line"></span><br><span class="line"><span class="comment">//通过sessionWithConfiguration:方法创建对象，也就是创建对应配置的会话，与NSURLSessionConfiguration合作使用</span></span><br><span class="line">+ (<span class="built_in">NSURLSession</span> *)sessionWithConfiguration:(<span class="built_in">NSURLSessionConfiguration</span> *)configuration;  </span><br><span class="line"></span><br><span class="line"><span class="comment">//通过设置配置、代理、队列来创建会话对象</span></span><br><span class="line">+ (<span class="built_in">NSURLSession</span> *)sessionWithConfiguration:(<span class="built_in">NSURLSessionConfiguration</span> *)configuration delegate:(<span class="keyword">id</span> &lt;<span class="built_in">NSURLSessionDelegate</span>&gt;)delegate delegateQueue:(<span class="built_in">NSOperationQueue</span> *)queue;</span><br></pre></td></tr></table></figure>
<p>NSURLSessionConfiguration其实是对NSURLSession的配置。<br>NSURLSession有以下三种模式，分别对应NSURLSessionConfiguration的三种创建模式：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSURLSessionConfiguration</span> *)defaultSessionConfiguration;  </span><br><span class="line">+ (<span class="built_in">NSURLSessionConfiguration</span> *)ephemeralSessionConfiguration;  </span><br><span class="line">+ (<span class="built_in">NSURLSessionConfiguration</span> *)backgroundSessionConfiguration:(<span class="built_in">NSString</span> *)identifier;</span><br></pre></td></tr></table></figure>

<ul>
<li>默认会话模式（default）：工作模式类似于原来的NSURLConnection，使用的是基于磁盘缓存的持久化策略，使用用户keychain中保存的证书进行认证授权。</li>
<li>瞬时会话模式（ephemeral）：该模式不使用磁盘保存任何数据。所有和会话相关的caches，证书，cookies等都被保存在RAM中，因此当程序使会话无效，这些缓存的数据就会被自动清空。（可以实现私密浏览）</li>
<li>后台会话模式（background）：该模式在后台完成上传和下载（在系统的一个单独的进程中执行），在创建Configuration对象的时候需要提供一个NSString类型的ID用于标识完成工作的后台会话。</li>
</ul>
<p>NSURLSessionConfiguration各个属性的设置:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果在后台任务正在传输时程序退出，可以使用这个identifier在程序重新启动是创建一个新的configuration和session关联之前传输。</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">readonly</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span>  *identifier;</span><br><span class="line"></span><br><span class="line"><span class="comment">//默认为空，NSURLRequest附件的请求头。</span></span><br><span class="line"><span class="comment">//这个属性会给所有使用该configuration的session生成的tasks中的NSURLRequest添加额外的请求头。</span></span><br><span class="line"><span class="comment">//如果这里边添加的请求头跟NSURLRequest中重复了，侧优先使用NSURLRequest中的头</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">copy</span>) <span class="built_in">NSDictionary</span>  *HTTPAdditionalHeaders;</span><br><span class="line"></span><br><span class="line"><span class="comment">//是否使用蜂窝网络，默认是yes.</span></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">BOOL</span> allowsCellularAccess;</span><br><span class="line"></span><br><span class="line"><span class="comment">//给request指定每次接收数据超时间隔</span></span><br><span class="line"><span class="comment">//如果下一次接受新数据用时超过该值，则发送一个请求超时给该request。默认为60s</span></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">NSTimeInterval</span>  timeoutIntervalForRequest;</span><br><span class="line"></span><br><span class="line"><span class="comment">//给指定resource设定一个超时时间，resource需要在时间到达之前完成</span></span><br><span class="line"><span class="comment">//默认是7天。 </span></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">NSTimeInterval</span>  timeoutIntervalForResource;</span><br><span class="line"></span><br><span class="line"><span class="comment">//discretionary属性为YES时表示当程序在后台运作时由系统自己选择最佳的网络连接配置，该属性可以节省通过蜂窝连接的带宽。</span></span><br><span class="line"><span class="comment">//在使用后台传输数据的时候，建议使用discretionary属性，而不是allowsCellularAccess属性，因为它会把WiFi和电源可用性考虑在内。</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">getter</span>=isDiscretionary) <span class="built_in">BOOL</span> discretionary;</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示当后台传输结束时，是否启动app.这个属性只对 生效，其他configuration类型会自动忽略该值。默认值是YES。</span></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">BOOL</span> sessionSendsLaunchEvents;</span><br><span class="line"></span><br><span class="line"><span class="comment">//是否启动通道，可以用于加快网络请求，默认是NO</span></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">BOOL</span> HTTPShouldUsePipelining;</span><br><span class="line"></span><br><span class="line">/===========储存的相关属性=============/</span><br><span class="line"></span><br><span class="line"><span class="comment">//存储cookie，清除存储，直接set为nil即可。</span></span><br><span class="line"><span class="comment">//对于默认和后台的session，使用sharedHTTPCookieStorage。</span></span><br><span class="line"><span class="comment">//对于短暂的session，cookie仅仅储存到内存，session失效时会自动清除。</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>) <span class="built_in">NSHTTPCookieStorage</span>  *HTTPCookieStorage;</span><br><span class="line"></span><br><span class="line"><span class="comment">//默认为yes,是否提供来自shareCookieStorge的cookie</span></span><br><span class="line"><span class="comment">//如果想要自己提供cookie，可以使用HTTPAdditionalHeaders来提供。</span></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">BOOL</span>  HTTPShouldSetCookies;</span><br><span class="line"></span><br><span class="line"><span class="comment">//证书存储，如果不使用，可set为nil.</span></span><br><span class="line"><span class="comment">//默认和后台session，默认使用的sharedCredentialStorage.</span></span><br><span class="line"><span class="comment">//短暂的session使用一个私有存储在内存中。session失效会自动清除。</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>) <span class="built_in">NSURLCredentialStorage</span> *URLCredentialStorage;</span><br><span class="line"></span><br><span class="line"><span class="comment">//缓存NSURLRequest的response。</span></span><br><span class="line"><span class="comment">//默认的configuration，默认值的是sharedURLCache。</span></span><br><span class="line"><span class="comment">//后台的configuration，默认值是nil</span></span><br><span class="line"><span class="comment">//短暂的configuration，默认一个私有的cache于内存，session失效，cache自动清除。</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">retain</span>) <span class="built_in">NSURLCache</span>  *URLCache;</span><br><span class="line"></span><br><span class="line"><span class="comment">//缓存策略，用于设置该会话中的Request的cachePolicy，如果Request有单独设置的话，以Request为准。</span></span><br><span class="line"><span class="comment">//默认值是NSURLRequestUseProtocolCachePolicy</span></span><br><span class="line"><span class="keyword">@property</span> <span class="built_in">NSURLRequestCachePolicy</span> requestCachePolicy;</span><br></pre></td></tr></table></figure>

<h2 id="3-NSURLSessionTask"><a href="#3-NSURLSessionTask" class="headerlink" title="3.NSURLSessionTask"></a>3.NSURLSessionTask</h2><p>根据NSURLSession来创建task进行网络请求</p>
<ul>
<li>NSURLSessionDataTask,可以用来处理一般的网络请求，如 GET | POST 请求等。</li>
<li>NSURLSessionUploadTask，用于处理上传请求。</li>
<li>NSURLSessionDownloadTask，主要用于处理下载请求。</li>
</ul>
<p>可以直接用异步回调的形式，也可以用代理的方式进行网络请求</p>
<h4 id="缓存"><a href="#缓存" class="headerlink" title="缓存:"></a>缓存:</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSUInteger</span>, <span class="built_in">NSURLRequestCachePolicy</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//对特定的 URL 请求使用网络协议中实现的缓存逻辑。这是默认的策略。</span></span><br><span class="line">    <span class="built_in">NSURLRequestUseProtocolCachePolicy</span> = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//数据需要从原始地址加载。不使用现有缓存。</span></span><br><span class="line">    <span class="built_in">NSURLRequestReloadIgnoringLocalCacheData</span> = <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不仅忽略本地缓存，同时也忽略代理服务器或其他中间介质目前已有的、协议允许的缓存。</span></span><br><span class="line">    <span class="built_in">NSURLRequestReloadIgnoringLocalAndRemoteCacheData</span> = <span class="number">4</span>, </span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSURLRequestReloadIgnoringCacheData</span> = <span class="built_in">NSURLRequestReloadIgnoringLocalCacheData</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//无论缓存是否过期，先使用本地缓存数据。如果缓存中没有请求所对应的数据，那么从原始地址加载数据。</span></span><br><span class="line">    <span class="built_in">NSURLRequestReturnCacheDataElseLoad</span> = <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//无论缓存是否过期，先使用本地缓存数据。如果缓存中没有请求所对应的数据，那么放弃从原始地址加载数据，请求视为失败（即：“离线”模式）。</span></span><br><span class="line">    <span class="built_in">NSURLRequestReturnCacheDataDontLoad</span> = <span class="number">3</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从原始地址确认缓存数据的合法性后，缓存数据就可以使用，否则从原始地址加载。</span></span><br><span class="line">    <span class="built_in">NSURLRequestReloadRevalidatingCacheData</span> = <span class="number">5</span>, </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="NSURLSessionDataTask"><a href="#NSURLSessionDataTask" class="headerlink" title="NSURLSessionDataTask"></a>NSURLSessionDataTask</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这两个方法需要设置代理来接收数据</span></span><br><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request;</span><br><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithURL:(<span class="built_in">NSURL</span> *)url;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这两个方法在completionHandler来接收数据</span></span><br><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSData</span> * _Nullable data, <span class="built_in">NSURLResponse</span> * _Nullable response, <span class="built_in">NSError</span> * _Nullable error))completionHandler;</span><br><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithURL:(<span class="built_in">NSURL</span> *)url completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSData</span> * _Nullable data, <span class="built_in">NSURLResponse</span> * _Nullable response, <span class="built_in">NSError</span> * _Nullable error))completionHandler;</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&quot;ViewController.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> () &lt;<span class="title">NSURLSessionDelegate</span>,<span class="title">NSURLSessionTaskDelegate</span>&gt;</span></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="comment">// Do any additional setup after loading the view, typically from a nib.</span></span><br><span class="line">    [<span class="keyword">self</span> sendRequest];</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)sendRequest&#123;</span><br><span class="line">    <span class="comment">//创建请求</span></span><br><span class="line">    <span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@&quot;http://httpbin.org/get&quot;</span>];</span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *request = [<span class="built_in">NSMutableURLRequest</span> requestWithURL:url];</span><br><span class="line">    <span class="comment">//设置request的缓存策略（决定该request是否要从缓存中获取）</span></span><br><span class="line">    request.cachePolicy = <span class="built_in">NSURLRequestReturnCacheDataElseLoad</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建配置（决定要不要将数据和响应缓存在磁盘）</span></span><br><span class="line">    <span class="built_in">NSURLSessionConfiguration</span> *configuration = [<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration];</span><br><span class="line">    <span class="comment">//configuration.requestCachePolicy = NSURLRequestReturnCacheDataElseLoad;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建会话</span></span><br><span class="line">    <span class="built_in">NSURLSession</span> *session = [<span class="built_in">NSURLSession</span> sessionWithConfiguration:configuration delegate:<span class="keyword">self</span> delegateQueue:<span class="literal">nil</span>];</span><br><span class="line">    <span class="comment">//生成任务</span></span><br><span class="line">    <span class="built_in">NSURLSessionDataTask</span> *task = [session dataTaskWithRequest:request];</span><br><span class="line">    <span class="comment">//创建的task是停止状态，需要我们去启动</span></span><br><span class="line">    [task resume];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//1.接收到服务器响应的时候调用</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask</span><br><span class="line">didReceiveResponse:(<span class="built_in">NSURLResponse</span> *)response</span><br><span class="line"> completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionResponseDisposition</span> disposition))completionHandler&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;接收响应&quot;</span>);</span><br><span class="line">    <span class="comment">//必须告诉系统是否接收服务器返回的数据</span></span><br><span class="line">    <span class="comment">//默认是completionHandler(NSURLSessionResponseAllow)</span></span><br><span class="line">    <span class="comment">//可以再这边通过响应的statusCode来判断否接收服务器返回的数据</span></span><br><span class="line">    completionHandler(<span class="built_in">NSURLSessionResponseAllow</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//2.接受到服务器返回数据的时候调用,可能被调用多次</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask didReceiveData:(<span class="built_in">NSData</span> *)data&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;接收到数据&quot;</span>);</span><br><span class="line">    <span class="comment">//一般在这边进行数据的拼接，在方法3才将完整数据回调</span></span><br><span class="line"><span class="comment">//    NSDictionary *dic = [NSJSONSerialization JSONObjectWithData:data options:0 error:nil];</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//3.请求完成或者是失败的时候调用</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session task:(<span class="built_in">NSURLSessionTask</span> *)task</span><br><span class="line">didCompleteWithError:(<span class="keyword">nullable</span> <span class="built_in">NSError</span> *)error&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;请求完成或者是失败&quot;</span>);</span><br><span class="line">    <span class="comment">//在这边进行完整数据的解析，回调</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//4.将要缓存响应的时候调用（必须是默认会话模式，GET请求才可以）</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask</span><br><span class="line"> willCacheResponse:(<span class="built_in">NSCachedURLResponse</span> *)proposedResponse</span><br><span class="line"> completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSCachedURLResponse</span> * _Nullable cachedResponse))completionHandler&#123;</span><br><span class="line">    <span class="comment">//可以在这边更改是否缓存，默认的话是completionHandler(proposedResponse)</span></span><br><span class="line">    <span class="comment">//不想缓存的话可以设置completionHandler(nil)</span></span><br><span class="line">    completionHandler(proposedResponse);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@&quot;http://www.connect.com/login&quot;</span>];</span><br><span class="line"><span class="built_in">NSMutableURLRequest</span> *request = [<span class="built_in">NSMutableURLRequest</span> requestWithURL:url];</span><br><span class="line">request.HTTPMethod = <span class="string">@&quot;POST&quot;</span>;</span><br><span class="line">request.HTTPBody = [<span class="string">@&quot;username=Tom&amp;pwd=123&quot;</span> dataUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用全局的会话</span></span><br><span class="line"><span class="built_in">NSURLSession</span> *session = [<span class="built_in">NSURLSession</span> sharedSession];</span><br><span class="line"><span class="comment">// 通过request初始化task</span></span><br><span class="line"><span class="built_in">NSURLSessionTask</span> *task = [session dataTaskWithRequest:request</span><br><span class="line">                                   completionHandler:^(<span class="built_in">NSData</span> *data, <span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSError</span> *error) &#123; </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, [<span class="built_in">NSJSONSerialization</span> JSONObjectWithData:data options:kNilOptions error:<span class="literal">nil</span>]);</span><br><span class="line"> &#125;];</span><br><span class="line"><span class="comment">//创建的task是停止状态，需要我们去启动</span></span><br><span class="line">[task resume];</span><br></pre></td></tr></table></figure>

<h4 id="NSURLSessionUploadTask"><a href="#NSURLSessionUploadTask" class="headerlink" title="NSURLSessionUploadTask"></a>NSURLSessionUploadTask</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/=========代理方式===========/</span><br><span class="line"><span class="comment">//通过文件url来上传</span></span><br><span class="line">- (<span class="built_in">NSURLSessionUploadTask</span> *)uploadTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request fromFile:(<span class="built_in">NSURL</span> *)fileURL;  </span><br><span class="line"><span class="comment">//通过文件data来上传</span></span><br><span class="line">- (<span class="built_in">NSURLSessionUploadTask</span> *)uploadTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request fromData:(<span class="built_in">NSData</span> *)bodyData;  </span><br><span class="line"><span class="comment">//通过文件流来上传</span></span><br><span class="line">- (<span class="built_in">NSURLSessionUploadTask</span> *)uploadTaskWithStreamedRequest:(<span class="built_in">NSURLRequest</span> *)request;</span><br><span class="line"></span><br><span class="line">/=========Block方式===========/</span><br><span class="line">- (<span class="built_in">NSURLSessionUploadTask</span> *)uploadTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request fromFile:(<span class="built_in">NSURL</span> *)fileURL completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSData</span> *data, <span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSError</span> *error))completionHandler;  </span><br><span class="line">- (<span class="built_in">NSURLSessionUploadTask</span> *)uploadTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request fromData:(<span class="built_in">NSData</span> *)bodyData completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSData</span> *data, <span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSError</span> *error))completionHandler;</span><br></pre></td></tr></table></figure>

<p>这三种上传方式分别针对什么应用场景呢？</p>
<ul>
<li>NSData：如果对象已经在内存里</li>
<li>File：如果对象在磁盘上，这样做有助于降低内存使用</li>
<li>Stream：通过流对象，你可以不用一次性将所有的流数据加载到内存中<br>不过使用Stream一定要实现URLSession:task:needNewBodyStream:，因为Session没办法在重新尝试发送Stream的时候找到数据源。</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//上传图片</span></span><br><span class="line">- (<span class="keyword">void</span>)uploadRequest&#123;</span><br><span class="line">    <span class="comment">//创建请求</span></span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> * request = [<span class="built_in">NSMutableURLRequest</span> requestWithURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@&quot;http://www.freeimagehosting.net/upload.php&quot;</span>]];</span><br><span class="line">    <span class="comment">//如果是上传文字就是@&quot;application/json&quot;</span></span><br><span class="line">    [request addValue:<span class="string">@&quot;image/jpeg&quot;</span> forHTTPHeaderField:<span class="string">@&quot;Content-Type&quot;</span>];</span><br><span class="line">    [request addValue:<span class="string">@&quot;text/html&quot;</span> forHTTPHeaderField:<span class="string">@&quot;Accept&quot;</span>];</span><br><span class="line">    [request setHTTPMethod:<span class="string">@&quot;POST&quot;</span>];</span><br><span class="line">    [request setCachePolicy:<span class="built_in">NSURLRequestReloadIgnoringCacheData</span>];</span><br><span class="line">    [request setTimeoutInterval:<span class="number">20</span>];</span><br><span class="line">    <span class="built_in">NSData</span> * imagedata = <span class="built_in">UIImageJPEGRepresentation</span>([<span class="built_in">UIImage</span> imageNamed:<span class="string">@&quot;person&quot;</span>],<span class="number">1.0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建配置（决定要不要将数据和响应缓存在磁盘）</span></span><br><span class="line">    <span class="built_in">NSURLSessionConfiguration</span> *configuration = [<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration];</span><br><span class="line">    <span class="comment">//创建会话</span></span><br><span class="line">    <span class="built_in">NSURLSession</span> *session = [<span class="built_in">NSURLSession</span> sessionWithConfiguration:configuration delegate:<span class="keyword">self</span> delegateQueue:<span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSURLSessionUploadTask</span> * uploadtask = [session uploadTaskWithRequest:request fromData:imagedata completionHandler:^(<span class="built_in">NSData</span> *data, <span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">        <span class="comment">//发送完成的回调</span></span><br><span class="line">        </span><br><span class="line">    &#125;];</span><br><span class="line">    [uploadtask resume];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//发送数据过程中会执行(执行多次)</span></span><br><span class="line">-(<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session task:(<span class="built_in">NSURLSessionTask</span> *)task didSendBodyData:(int64_t)bytesSent totalBytesSent:(int64_t)totalBytesSent totalBytesExpectedToSend:(int64_t)totalBytesExpectedToSend&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;发送数据中&quot;</span>);</span><br><span class="line">    <span class="comment">//在这边监听发送的进度</span></span><br><span class="line">    <span class="comment">//progress = totalBytesSent/(float)totalBytesExpectedToSend</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="NSURLSessionDownloadTask"><a href="#NSURLSessionDownloadTask" class="headerlink" title="NSURLSessionDownloadTask"></a>NSURLSessionDownloadTask</h4><ul>
<li>下载文件可以实现断点下载</li>
<li>内部已经完成了边接收数据边写入沙盒的操作（直接下载到磁盘）</li>
<li>支持BackgroundSession（后台下载）</li>
</ul>
<p>使用NSURLSessionDownloadTask 下载文件的过程与前面差不多，需要注意的是文件下载文件之后会自动保存到一个临时目录(temp)，需要开发人员自己将此文件重新放到其他指定的目录中。 或者直接在内存里面显示, 默认异步的.NSURLSession 自动不会出现内存暴涨情况</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/=========代理方式===========/</span><br><span class="line">- (<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request;  </span><br><span class="line">- (<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTaskWithURL:(<span class="built_in">NSURL</span> *)url;  </span><br><span class="line"><span class="comment">//通过之前已经下载的数据来创建下载任务</span></span><br><span class="line">- (<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTaskWithResumeData:(<span class="built_in">NSData</span> *)resumeData;  </span><br><span class="line"></span><br><span class="line">/=========Block方式===========/</span><br><span class="line">- (<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURL</span> *location, <span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSError</span> *error))completionHandler;  </span><br><span class="line">- (<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTaskWithURL:(<span class="built_in">NSURL</span> *)url completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURL</span> *location, <span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSError</span> *error))completionHandler;  </span><br><span class="line">- (<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTaskWithResumeData:(<span class="built_in">NSData</span> *)resumeData completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURL</span> *location, <span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSError</span> *error))completionHandler;</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)downloadRequest&#123;</span><br><span class="line">    <span class="comment">//创建请求</span></span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> * request = [<span class="built_in">NSMutableURLRequest</span> requestWithURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@&quot;http://httpbin.org/image/jpeg&quot;</span>]];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建配置（决定要不要将数据和响应缓存在磁盘）</span></span><br><span class="line">    <span class="built_in">NSURLSessionConfiguration</span> *configuration = [<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration];</span><br><span class="line">    <span class="comment">//创建会话</span></span><br><span class="line">    <span class="built_in">NSURLSession</span> *session = [<span class="built_in">NSURLSession</span> sessionWithConfiguration:configuration delegate:<span class="keyword">self</span> delegateQueue:<span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSURLSessionDownloadTask</span> * downloadtask = [session downloadTaskWithRequest:request];</span><br><span class="line">    [downloadtask resume];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//1. downloadTask下载过程中会执行</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session downloadTask:(<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTask didWriteData:(int64_t)bytesWritten totalBytesWritten:(int64_t)totalBytesWritten totalBytesExpectedToWrite:(int64_t)totalBytesExpectedToWrite&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;下载中...&quot;</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;写入数据大小%lld，总写入数据大小%lld，总期望数据大小%lld&quot;</span>,bytesWritten,totalBytesWritten,totalBytesExpectedToWrite);</span><br><span class="line">    <span class="comment">//监听下载的进度</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//2.downloadTask下载完成的时候会执行</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session downloadTask:(<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTask didFinishDownloadingToURL:(<span class="built_in">NSURL</span> *)location&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;下载完成&quot;</span>);</span><br><span class="line">       <span class="comment">//该方法内部已经完成了边接收数据边写沙盒的操作，解决了内存飙升的问题</span></span><br><span class="line">    <span class="comment">//对数据进行使用，或者保存（默认存储到临时文件夹 tmp 中，需要剪切文件到 cache）</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//保存</span></span><br><span class="line">    <span class="built_in">NSString</span> *filePath = [[<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSCachesDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>) lastObject] stringByAppendingPathComponent:downloadTask.response.suggestedFilename];</span><br><span class="line">    [[<span class="built_in">NSFileManager</span> defaultManager] moveItemAtURL:location toURL:[<span class="built_in">NSURL</span> fileURLWithPath:filePath] error:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用</span></span><br><span class="line">    <span class="built_in">NSData</span> * data = [<span class="built_in">NSData</span> dataWithContentsOfURL:location.filePathURL];</span><br><span class="line">    <span class="built_in">UIImage</span> * image = [<span class="built_in">UIImage</span> imageWithData:data];</span><br><span class="line">    <span class="built_in">UIImageWriteToSavedPhotosAlbum</span>(image, <span class="literal">nil</span>,<span class="literal">nil</span>,<span class="literal">nil</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//3.请求完成或者是失败的时候调用(Session层次的Task完成的事件)</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session task:(<span class="built_in">NSURLSessionTask</span> *)task</span><br><span class="line">didCompleteWithError:(<span class="keyword">nullable</span> <span class="built_in">NSError</span> *)error&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;请求完成或者是失败&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>断点续传:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用这种方式取消下载可以得到将来用来恢复的数据,保存起来</span></span><br><span class="line">[<span class="keyword">self</span>.task cancelByProducingResumeData:^(<span class="built_in">NSData</span> *resumeData) &#123;</span><br><span class="line">    <span class="keyword">self</span>.resumeData = resumeData;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 由于下载失败导致的下载中断会进入此协议方法,也可以得到用来恢复的数据</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session task:(<span class="built_in">NSURLSessionTask</span> *)task didCompleteWithError:(<span class="built_in">NSError</span> *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 保存恢复数据</span></span><br><span class="line">    <span class="keyword">self</span>.resumeData = error.userInfo[<span class="built_in">NSURLSessionDownloadTaskResumeData</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 恢复下载时接过保存的恢复数据</span></span><br><span class="line"><span class="keyword">self</span>.task = [<span class="keyword">self</span>.session downloadTaskWithResumeData:<span class="keyword">self</span>.resumeData];</span><br><span class="line"><span class="comment">// 启动任务</span></span><br><span class="line">[<span class="keyword">self</span>.task resume];</span><br></pre></td></tr></table></figure>

<p>后台下载</p>
<p>使用后台会话进行下程序退出到后台也能正常下载完成,但是程序在后台UI无法更新,不能获取进度;这时,我们需要通过应用程序代理进行UI更新,原理如图:</p>
<p><img src="/images/img1.png"></p>
<p>当NSURLSession在后台开启几个任务之后,如果其中有任务完成,系统就会会调用此APP的代理方法:<code>- (void)application:(UIApplication *)application handleEventsForBackgroundURLSession:(NSString *)identifiercompletionHandler:(void (^)(void))completionHandler</code>里进行完成的操作. 通常我们会保持此对象,直到最后一个任务完成;<br>此时会重新通过会话标识(config中设置的)找到对应会话并调用NSURLSession的<code>-(void)URLSessionDidFinishEventsForBackgroundURLSession:(NSURLSession * )session</code>代理方法例进行UI的更新.并调用completionHandler通知系统已经完成所有操作。具体如下:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="keyword">void</span>)application:(<span class="built_in">UIApplication</span> *)application handleEventsForBackgroundURLSession:(<span class="built_in">NSString</span> *)identifier completionHandler:(<span class="keyword">void</span> (^)())completionHandler&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//backgroundSessionCompletionHandler是自定义的一个属性</span></span><br><span class="line">    <span class="keyword">self</span>.backgroundSessionCompletionHandler=completionHandler;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)URLSessionDidFinishEventsForBackgroundURLSession:(<span class="built_in">NSURLSession</span> *)session&#123;</span><br><span class="line">    AppDelegate *appDelegate = (AppDelegate *)[[<span class="built_in">UIApplication</span> sharedApplication] delegate];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Other Operation....</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (appDelegate.backgroundSessionCompletionHandler) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">void</span> (^completionHandler)() = appDelegate.backgroundSessionCompletionHandler;     </span><br><span class="line">        appDelegate.backgroundSessionCompletionHandler = <span class="literal">nil</span>;        </span><br><span class="line">        completionHandler();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用GCD进行一次发起多个请求，全部完成后进行统一处理</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">let group : dispatch_group_t = dispatch_group_create()</span><br><span class="line">let queue : <span class="built_in">dispatch_queue_t</span> = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">dispatch_group_async(group, queue) &#123; </span><br><span class="line">  dispatch_group_enter(group)</span><br><span class="line">  <span class="comment">//发起第一个请求</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dispatch_group_async(group, queue) &#123;</span><br><span class="line">  dispatch_group_enter(group)</span><br><span class="line">  <span class="comment">//发起第二个请求</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dispatch_group_notify(group, queue) &#123;</span><br><span class="line">  <span class="comment">//全部完成后，进行统一处理</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//每个请求完成时，调用dispatch_group_leave(group)</span></span><br></pre></td></tr></table></figure>

<p>参考:</br><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/a8fc22afb739">https://www.jianshu.com/p/a8fc22afb739</a><br><a target="_blank" rel="noopener" href="http://blog.csdn.net/csdnhaoren13/article/details/50809506">http://blog.csdn.net/csdnhaoren13/article/details/50809506</a></p>

    </div>

    <div class="about">
        <h1>About this Post</h1>
        <p>This post is written by 氯化钠哦, licensed under <a
                target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
    </div>

    
        
    
</article>
        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h4 class="title">Blog</h4>
                
                <a href="/" class="item" target="_blank">Blog</a>
                
                <a href="/archives" class="item" target="_blank">Archives</a>
                
                <a href="/friends" class="item" target="_blank">Friends</a>
                
                <a href="/projects" class="item" target="_blank">Projects</a>
                
                <a href="/resume" class="item" target="_blank">Resume</a>
                
                <a href="/about" class="item" target="_blank">About</a>
                
                <a href="/atom.xml" class="item" target="_blank">RSS</a>
                
            </div>
            
            <div class="group">
                <h4 class="title">Projects</h4>
                
            </div>
            
            <div class="group">
                <h4 class="title">Me</h4>
                
                <a href="https://github.com/NaCl424" class="item" target="_blank">GitHub</a>
                
                <a href="https://www.zhihu.com/hot" class="item" target="_blank">Zhihu</a>
                
                <a href="https://weibo.com/" class="item" target="_blank">Weibo</a>
                
                <a href="mailto:2935288967@qq.com" class="item" target="_blank">Email</a>
                
            </div>
            
        </div>
        &copy; 2021 氯化钠哦<br />
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
</footer>

        
<script src="/js/main.js"></script>

        
    </body>
</html>